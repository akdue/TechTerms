# **Bare Metal**

## الترجمة الحرفية  
**Bare Metal** — **تشغيل مباشر على العتاد** من دون **Hypervisor** أو طبقة افتراضية.

## الوصف العربي المختصر  
تُنشر أنظمتك وتطبيقاتك على **خوادم فعلية** مملوكة/مستأجرة لك.  
تحصل على **أقصى أداء** وتحكّم كامل بالـ BIOS/UEFI والتوصيل والتخزين، مقابل **إدارة أعقد** ومرونة أقل من السحابة.

## الشرح المبسّط  
- لا توجد طبقة وسطى (Hypervisor). نظام التشغيل يعمل **مباشرة** على المعالج/الذاكرة/الأقراص.  
- مناسب لـ **زمن استجابة منخفض جدًا**، **أحمال I/O كثيفة**، أو **أجهزة متخصّصة** (GPU/FPGA/NVMe محلي).  
- يتطلب منك إدارة: **العتاد، التبريد، الطاقة، RAID، تحديثات Firmware**.

## تشبيه  
امتلاكك **مطعمك الخاص** بمعدّاته داخل مبناك. حرية كاملة، أداء أعلى،  
لكن عليك الاهتمام بكل شيء: الكهرباء، الصيانة، المخزون، الأمن.

---

## مثال كود C# — ضبط عملي لأداء أعلى على عتاد مباشر
> يبيّن: **أولوية العملية/الخيط**، **تثبيت المعالج (Affinity)**، و**منطقة بلا GC** لتقليل التذبذب.

```csharp
// .NET 8/9
using System;
using System.Diagnostics;
using System.Threading;

class BareMetalTuning
{
    static void Main()
    {
        // 1) أولوية العملية والخيط
        var proc = Process.GetCurrentProcess();
        proc.PriorityClass = ProcessPriorityClass.High;              // قد تتطلب صلاحيات
        Thread.CurrentThread.Priority = ThreadPriority.Highest;

        // 2) تثبيت الخيط على نواة معيّنة (CPU 0 كمثال)
        IntPtr mask = (IntPtr)1;                                     // 0001b = CPU#0
        proc.ProcessorAffinity = mask;

        // 3) منع GC مؤقتًا لتقليل التذبذب (احسب حجم العمل المتوقع)
        bool noGc = false;
        try { noGc = GC.TryStartNoGCRegion(16 * 1024 * 1024); }      // 16MB
        catch { /* تجاهل عند الفشل */ }

        // 4) قياس كمون عملية بسيطة
        var sw = new Stopwatch();
        long min = long.MaxValue, max = 0, sum = 0, N = 20000;
        for (int i = 0; i < N; i++)
        {
            sw.Restart();
            // عمل صغير يحاكي معالجة طلب
            double x = Math.Sqrt(i) * Math.PI;
            sw.Stop();

            long ns = (long)(sw.ElapsedTicks * (1_000_000_000.0 / Stopwatch.Frequency));
            if (ns < min) min = ns; if (ns > max) max = ns; sum += ns;
        }

        if (noGc) GC.EndNoGCRegion();

        Console.WriteLine($"Affinity: {proc.ProcessorAffinity}");
        Console.WriteLine($"Latency ns -> min:{min}  avg:{sum/N}  max:{max}");
        Console.WriteLine("Tip: ثبّت الطاقة على 'Performance' من BIOS/OS وراقب الحرارة.");
    }
}
```

**الفكرة:** على Bare Metal يمكنك دفع العتاد لأقصى أداء:  
أولوية أعلى، تثبيت CPU، تهيئة الطاقة/التبريد، وأقراص NVMe محلية… لكن احذر من السلامة والحرارة.

---

## خطوات عملية لاعتماد Bare Metal (Checklist)
- **التخطيط والشراء/التأجير**  
  - اختر معالجات/ذاكرة/أقراص وفق الحمل (CPU-bound, RAM-bound, IOPS).  
  - وفّر **ازدواجية** في الطاقة (PSU) والشبكة (NICs) والتخزين (RAID10/ZFS).  
  - إدارة عن بُعد: **IPMI/iDRAC/iLO** مع وصول آمن (VPN/ACL).
- **تهيئة BIOS/UEFI**  
  - ملف تعريف الطاقة: **Performance**، وحدّث **Firmware** دوريًا.  
  - لضغط الكمون: قلّل **C-States** العميقة، فعّل **NUMA Awareness**، واضبط **Hyper-Threading** حسب الحمل.  
  - فعّل **VT-x/AMD-V/IOMMU** إن كنت ستستخدم حاويات مسرَّعة أو تمرير أجهزة.
- **نظام التشغيل والتخزين**  
  - اختر نظامًا مناسبًا (Windows/Linux) مع برنامج RAID/ZFS أو متحكّم HW.  
  - استخدم **NVMe محلي** لقواعد البيانات الحساسة، و**شبكات تخزين** للأرشفة.  
  - راقب SMART/درجات الحرارة، وخطّط لـ **Backups** خارج الماكينة.
- **الشبكات**  
  - بطاقات 10/25/40/100GbE حسب الحاجة؛ فرق قنوات (LACP) ومسارات مزدوجة.  
  - جدار ناري على النظام + قوائم ACL عند السويتش/الموجّه.
- **المراقبة والتشغيل**  
  - اجمع **Logs/Metrics/Tracing** (Prometheus/WMI/ETW).  
  - تنبيهات حرارة/مراوح/أقراص/استهلاك طاقة.  
  - جداول صيانة وتحديث Firmware/OS.

---

## أخطاء شائعة
- تجاهل **التبريد والطاقة** → اختناق حراري/إعادة تشغيل.  
- عدم تأمين **IPMI** (منكشف على الإنترنت) → مخاطرة حرجة.  
- لا RAID/لا نسخ احتياطي → فقدان بيانات عند فشل قرص.  
- تجاهل **NUMA** وتوزيع الذاكرة/الخيوط → أداء يتدهور تحت الحمل.  
- استخدام قرص نظام واحد لكل شيء → اختناقات I/O.  
- عدم توثيق تغييرات BIOS/Firmware → صعوبة تكرار وحل مشاكل.

---

## جدول مقارنة مختصر

| المفهوم                               | الغرض الرئيسي                    | ملاحظات مهمة                                               |
| ------------------------------------- | -------------------------------- | ---------------------------------------------------------- |
| **Bare Metal**                        | **أقصى أداء وتحكّم كامل بالعتاد** | **إدارة أعقد؛ مسؤولية كاملة عن الطاقة/التبريد/الFirmware** |
| [Hypervisor](hypervisor.md)           | تقسيم العتاد لعدة VMs            | مرونة وعزل جيد؛ خفض بسيط في الأداء                         |
| [Virtual Machine](virtual-machine.md) | نظام كامل معزول فوق Hypervisor   | سهل النقل/النسخ؛ أثقل من الحاويات                          |
| [Container](container.md)             | عزل خفيف يشارك نواة المضيف       | سريع الإقلاع؛ يعتمد على نواة المضيف؛ عزل أضعف من VM        |

## ملخص الفكرة  
**Bare Metal** يمنحك **السرعة القصوى** والتحكّم الكامل، وهو خيار ممتاز للأحمال الحسّاسة للكمون أو الأجهزة المتخصّصة.  
لكنّه يتطلب **إدارة دقيقة** للعتاد والطاقة والتخزين والأمن. إن لم تحتج هذا المستوى من التحكم، فكّر في **VMs** أو **PaaS/Containers** لتقليل التعقيد.
